%%
%% Personal plain TeX macros.
%% Can only be used with LuaTeX, requires luaotfload.sty in a searchable path.
%%


%%%%%%%%% F O N T S %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

% Use font loader from ConTeXt
\input luaotfload.sty

% Font names
\font\tenrm "EBGaramond-Regular" at 10pt\relax
\font\tenit "EBGaramond-Italic" at 10pt\relax
\font\tensc "EBGaramond-Regular":+pcap,letterspace=6; at 10pt\relax

\font\twelverm "EBGaramond-Regular" at 12pt\relax
\font\twelveit "EBGaramond-Italic" at 12pt\relax
\font\twelvesc "EBGaramond-Regular":+pcap,letterspace=6; at 12pt\relax

% Semantic names for direct use
\def\normalsize{%
	\gdef\rm{\tenrm}%
	\gdef\it{\tenit}%
	\gdef\sc{\tensc}%
}

\def\bigsize{%
	\gdef\rm{\twelverm}%
	\gdef\it{\twelveit}%
	\gdef\sc{\twelvesc}%
}

% Use italics for emphasis
\let\emph\it

% Start with normalsize roman
\normalsize\rm


%%%%%%%%% P A R A G R A P H   S E T T I N G S %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

% Default distance between lines
\baselineskip=15pt

% No extra space after periods.
\frenchspacing

% Vertical distance between paragraphs
\parskip=0pt

% Paragraph indentation
\parindent=1em

% Allow some looseness if needed
\emergencystretch=8pt

% \firstnoindent -- Don't indent next paragraph
\def\firstnoindent{\global\everypar={\wipeeverypar\setbox7=\lastbox}}
\def\wipeeverypar{\global\everypar={}}

%%%%%%%%% P A G E   L A Y O U T %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

% Paper size
\pagewidth=180mm	
\pageheight=200mm

% Undo legacy 1in origin
\pdfvariable horigin 0in	
\pdfvariable vorigin 0in

% Typeset area distance from top left corner
\hoffset=15mm	
\voffset=15mm

% Ensure that first baseline starts at the same distance from the top
\topskip=\baselineskip

% Typeset area size
\hsize=120mm	
\vsize=\topskip \advance\vsize by 4\baselineskip


% Macro to lengthen or shorten pages by lines
\newdimen\originalvsize \originalvsize=\vsize

% Example, adjust page 15 to be 2 lines longer: \adjustpage{15}{+2}
% Defines a macro \ap:<pageno>, expands to how many lines should be adjusted.
\def\adjustpage#1#2{%
	\expandafter\xdef\csname ap:#1\endcsname{#2}
	\ifnum #1=1
		\setvsize
	\fi
}

% This macro gets expanded last in the output routine
\def\setvsize{%
	\global\vsize=\originalvsize
	\ifcsname ap:\the\pageno\endcsname
		\global\advance \vsize by \csname ap:\the\pageno\endcsname \baselineskip
	\fi
}


%%%%%%%%% H E A D E R %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\newif\ifheadline \headlinetrue

\headline{%
	\ifheadline
		\ifodd\pageno
			\hss{\normalsize\rm \defaultcolor [Recto header]}\hss% recto
		\else
			\hss{\normalsize\rm \defaultcolor [Verso header]}\hss% verso	
		\fi
	\else
		\hss
		\global\headlinetrue	
	\fi
}

% Turn off headline on current page
\def\thispagenoheadline{\global\headlinefalse}


%%%%%%%%% F O O T E R %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\newif\iffootline \footlinetrue

\footline{%
	\iffootline
		\ifodd\pageno
			\hss{\normalsize\rm \defaultcolor \folio}% recto
		\else
			{\normalsize\rm \defaultcolor \folio}\hss% verso	
		\fi
	\else
		\hss
		\global\footlinetrue	
	\fi
}

% Turn off footline on current page
\def\thispagenofootline{\global\footlinefalse}


%%%%%%%%%% C O L O R S %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

% Token for \aftergroup to reset color
\def\colorstackpop{\pdfextension colorstack 0 pop}

% Switch to CMYK color in current group. Expects four values between 0 and 1
\def\setcmykcolor#1{%
   	\pdfextension colorstack 0 push {#1 k #1 K}% 
   	\aftergroup\colorstackpop
}

% Switch to RGB color in current group. Expects three values between 0 and 1
\def\setrgbcolor#1{%
   	\pdfextension colorstack 0 push {#1 rg #1 RG}% 
   	\aftergroup\colorstackpop
}

% Color names
\def\black{\setcmykcolor{0 0 0 1}}
\def\blue{\setcmykcolor{1 1 0 0}}
\def\red{\setrgbcolor{1 0 0}}

% Semantic names for direct use
\def\defaultcolor{\black}
\def\hyperlinkcolor{\blue}
\def\rubricationcolor{\red}

% Example: {\hyperlinkcolor This is blue text}


%%%%%%%%% I M A G E S %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\newdimen\imagewidth    \imagewidth=0pt 	% 0pt gives natural size of image
\newdimen\imageheight   \imageheight=0pt
\newtoks\imagedir		\imagedir{} 		% Must end with /, e.g. mypics/

\def\image#1{%
	\hbox{%
		\saveimageresource 
			\ifdim\imagewidth=0pt \else width\imagewidth\fi 
            \ifdim\imageheight=0pt \else height\imageheight\fi 
            {\the\imagedir#1}%
      	\useimageresource\lastsavedimageresourceindex
	}%
}

% Example: {\imageheight=4cm \image{mypicture.png}}

%%%%%%%%% O U T P U T   R O U T I N E %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\output{\beforeoutput \plainoutput \afteroutput}

\def\beforeoutput{%
	% Two page layout
	\ifodd\pageno
		\hoffset=15mm
	\else
		\hoffset=45mm
	\fi
}

\def\afteroutput{%
	\setvsize
}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%         C O N T E N T
          
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\adjustpage{2}{+2}
\adjustpage{5}{-1}


\input lipsum
\input lipsum
\input lipsum
\input lipsum

\bye
